name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write
  packages: write

jobs:
  # ===================
  # Create Release
  # ===================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: get-version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        uses: orhun/git-cliff-action@v3
        with:
          config: cliff.toml
          args: --latest --strip header
        env:
          OUTPUT: CHANGELOG.md
        continue-on-error: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release v${{ steps.get-version.outputs.version }}
          body: |
            ## What's Changed

            ${{ steps.changelog.outputs.content }}

            ## Docker Images

            ```bash
            # Frontend
            docker pull ghcr.io/${{ github.repository_owner }}/aucsafe-frontend:${{ steps.get-version.outputs.version }}

            # Backend
            docker pull ghcr.io/${{ github.repository_owner }}/aucsafe-backend:${{ steps.get-version.outputs.version }}

            # AI Service
            docker pull ghcr.io/${{ github.repository_owner }}/aucsafe-ai-service:${{ steps.get-version.outputs.version }}
            ```

            ## Deployment

            ```bash
            # Deploy to Kubernetes
            kubectl apply -k infra/k8s/overlays/prod
            ```
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
          generate_release_notes: true

  # ===================
  # Deploy to Production
  # ===================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: release
    environment:
      name: production
      url: https://aucsafe.example.com
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "v1.28.0"

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > ~/.kube/config

      - name: Update image tags to release version
        run: |
          cd infra/k8s/overlays/prod
          VERSION=${{ needs.release.outputs.version }}
          kustomize edit set image \
            aucsafe/frontend=ghcr.io/${{ github.repository_owner }}/aucsafe-frontend:$VERSION \
            aucsafe/backend=ghcr.io/${{ github.repository_owner }}/aucsafe-backend:$VERSION \
            aucsafe/ai-service=ghcr.io/${{ github.repository_owner }}/aucsafe-ai-service:$VERSION

      - name: Deploy to Kubernetes
        run: |
          kubectl apply -k infra/k8s/overlays/prod

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/prod-frontend -n aucsafe-prod --timeout=600s
          kubectl rollout status deployment/prod-backend -n aucsafe-prod --timeout=600s
          kubectl rollout status deployment/prod-ai-service -n aucsafe-prod --timeout=600s

      - name: Verify deployment
        run: |
          kubectl get pods -n aucsafe-prod
          echo "Deployment of v${{ needs.release.outputs.version }} complete"

      - name: Notify release
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ðŸš€ New Release Deployed!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ðŸš€ *AucSafe v${{ needs.release.outputs.version }} Released!*\n\nDeployed to production successfully.\n\n<https://github.com/${{ github.repository }}/releases/tag/v${{ needs.release.outputs.version }}|View Release Notes>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
